<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOTP 动态口令生成器 - 安全验证解决方案</title>
    <link rel="shortcut icon" href="img/logo.png"/>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="cdn/element-ui/theme-chalk/index.css">
    <script src="cdn/vue/vue.js"></script>
    <script src="cdn/element-ui/index.js"></script>
    <script src="cdn/qrcode/qrcode.min.js"></script>
    <script src="cdn/crypto-js/crypto-js.min.js"></script>
    <script src="cdn/dayjs/dayjs.min.js"></script>
    <script src="../dist/notp.min.js"></script>
    <script>
        (function () {
            if (typeof notp === 'undefined') {
                var src = '//raw.githubusercontent.com/yutons/notp/refs/heads/main/dist/notp.min.js';
                document.write('<scr' + 'ipt src="' + src + '"></scr' + 'ipt>');
            }
        })();
    </script>
</head>
<body>
<div class="app-container" id="app">
    <header>
        <div class="logo-icon">
            <img src="img/logo.png" width="48px" height="48px"/>
        </div>
        <div class="header-content">
            <div class="logo">NOTP 动态口令生成器</div>
            <div class="app-description">基于时间的一次性密码 (TOTP) 解决方案</div>
        </div>
        <div>
            <a href="../" target="_blank">
                <svg t="1754911948145" class="icon" viewBox="0 0 1024 1024" version="1.1"
                     xmlns="http://www.w3.org/2000/svg" p-id="8725" width="32" height="32">
                    <path d="M0 512c0 282.770286 229.229714 512 512 512s512-229.229714 512-512S794.770286 0 512 0 0 229.229714 0 512z"
                          fill="#EC8618" p-id="8726"></path>
                    <path d="M739.718095 341.333333H259.900952A40.472381 40.472381 0 0 0 219.428571 381.732571v264.167619c0 22.332952 18.139429 40.472381 40.472381 40.472381h479.890286c22.357333 0 40.472381-18.139429 40.399238-40.399238V381.732571A40.472381 40.472381 0 0 0 739.718095 341.333333z m-223.695238 264.167619h-53.881905v-105.130666l-53.881904 67.364571-53.881905-67.364571v105.130666h-54.076953v-183.296h53.881905l53.881905 67.388953 53.881905-67.388953h53.881905v183.296h0.195047z m118.540191 2.730667l-80.871619-94.354286h53.881904v-91.672381h53.881905v91.672381h53.881905l-80.774095 94.354286z"
                          fill="#FFFFFF" p-id="8727"></path>
                </svg>
            </a>
            <a href="https://github.com/yutons/notp" target="_blank">
                <svg t="1754907749019" class="icon" viewBox="0 0 1024 1024" version="1.1"
                     xmlns="http://www.w3.org/2000/svg" p-id="6842" width="32" height="32">
                    <path
                            d="M512 42.666667A464.64 464.64 0 0 0 42.666667 502.186667 460.373333 460.373333 0 0 0 363.52 938.666667c23.466667 4.266667 32-9.813333 32-22.186667v-78.08c-130.56 27.733333-158.293333-61.44-158.293333-61.44a122.026667 122.026667 0 0 0-52.053334-67.413333c-42.666667-28.16 3.413333-27.733333 3.413334-27.733334a98.56 98.56 0 0 1 71.68 47.36 101.12 101.12 0 0 0 136.533333 37.973334 99.413333 99.413333 0 0 1 29.866667-61.44c-104.106667-11.52-213.333333-50.773333-213.333334-226.986667a177.066667 177.066667 0 0 1 47.36-124.16 161.28 161.28 0 0 1 4.693334-121.173333s39.68-12.373333 128 46.933333a455.68 455.68 0 0 1 234.666666 0c89.6-59.306667 128-46.933333 128-46.933333a161.28 161.28 0 0 1 4.693334 121.173333A177.066667 177.066667 0 0 1 810.666667 477.866667c0 176.64-110.08 215.466667-213.333334 226.986666a106.666667 106.666667 0 0 1 32 85.333334v125.866666c0 14.933333 8.533333 26.88 32 22.186667A460.8 460.8 0 0 0 981.333333 502.186667 464.64 464.64 0 0 0 512 42.666667"
                            fill="#231F20" p-id="6843"></path>
                </svg>
            </a>
            <a href="https://www.npmjs.com/package/@yutons/notp" target="_blank">
                <svg t="1754907807094" class="icon" viewBox="0 0 1024 1024" version="1.1"
                     xmlns="http://www.w3.org/2000/svg" p-id="9715" width="32" height="32">
                    <path
                            d="M117.149737 906.850263V117.160081h789.690182v789.690182z m148.521374-641.706667v492.533657h248.873374V367.843556h145.025293v389.906101h98.735321V265.143596z"
                            fill="#CB3837" p-id="9716"></path>
                </svg>
            </a>
        </div>
    </header>

    <main>
        <section class="config-panel">
            <h2 class="panel-title">
                <i class="fas fa-sliders-h"></i> TOTP参数配置
            </h2>

            <div class="control-group">
                <div class="control-header">
                    <div class="control-label">Period</div>
                    <div class="description">令牌有效周期（TOTP标准参数，以秒为单位）</div>
                </div>
                <div class="value-display">
                    {{ form.duration }}
                    <span class="small-label">秒</span>
                </div>
                <div class="slider-container">
                    <el-slider v-model="form.duration" :min="10" :max="90" :step="5" show-stops></el-slider>
                </div>
            </div>

            <div class="control-group" style="display: flex;">
                <div class="config-section">
                    <div class="control-header">
                        <div class="control-label">Digits</div>
                        <div class="description">令牌长度（6位或8位）</div>
                    </div>
                    <div class="value-display">
                        {{ form.digits }}
                        <span class="small-label">位</span>
                    </div>
                    <div class="slider-container">
                        <el-radio-group v-model="form.digits" size="small">
                            <el-radio-button :label="6">6位</el-radio-button>
                            <el-radio-button :label="8">8位</el-radio-button>
                        </el-radio-group>
                    </div>
                </div>

                <div class="config-section">
                    <div class="control-header">
                        <div class="control-label">Algorithm</div>
                        <div class="description">HMAC计算使用的哈希算法</div>
                    </div>
                    <div class="value-display">
                        {{ form.algorithm }}
                    </div>
                    <div class="slider-container">
                        <el-radio-group v-model="form.algorithm" size="small">
                            <el-radio-button label="sha1">SHA-1</el-radio-button>
                            <el-radio-button label="sha256">SHA-256</el-radio-button>
                            <el-radio-button label="sha512">SHA-512</el-radio-button>
                        </el-radio-group>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="control-header">
                    <div class="control-label">Secret Key</div>
                    <div class="description">Base32编码的共享密钥</div>
                </div>
                <el-input v-model="form.secret" placeholder="请输入用于生成令牌的密钥"></el-input>
                <p class="description">
                    符合RFC 6238的Base32编码密钥（推荐长度32字符）。使用安全随机源生成。
                </p>
                <div class="secret-actions">
                    <button class="btn btn-outline" @click="generateSecret">
                        <i class="fas fa-sync-alt"></i> 重新生成
                    </button>
                    <button class="btn btn-outline" @click="copySecret">
                        <i class="fas fa-copy"></i> 复制密钥
                    </button>
                </div>
            </div>

            <div class="control-group">
                <div class="account-issuer">
                    <div class="account-group">
                        <div class="control-header">
                            <div class="control-label">账户</div>
                            <div class="description">例如: username@example.com</div>
                        </div>
                        <el-input v-model="form.account" placeholder="请输入账户名称"></el-input>
                    </div>

                    <div class="issuer-group">
                        <div class="control-header">
                            <div class="control-label">颁发者</div>
                            <div class="description">例如: Google, Microsoft</div>
                        </div>
                        <el-input v-model="form.issuer" placeholder="请输入颁发者"></el-input>
                    </div>
                </div>
            </div>
        </section>

        <section class="code-panel">
            <div class="app-status">
                <div>当前时间：{{ current }}</div>
                <div v-if="loading" class="loading-text">生成令牌中...</div>
                <div v-if="error" class="error-message">{{ error }}</div>
            </div>

            <div class="token-display-container">
                <div class="token-display" :class="{'token-update': tokenUpdated}">
                    {{ token }}
                </div>
                <el-progress type="circle" :percentage="progressPercentage" :color="progressColor"
                             :text-color="progressColor" stroke-linecap="butt" :stroke-width="5" :width="64"
                             :format="format">
                    <span class="countdown-text">{{ duration }}</span>
                </el-progress>
            </div>

            <div class="qrcode-container">
                <div class="qrcode-title">扫描二维码添加到身份验证器</div>
                <div class="qrcode" ref="qrcode">
                    <div v-if="!qrCodeLoaded" class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">生成二维码中...</div>
                    </div>
                </div>
                <div class="description">使用Google Authenticator等APP扫描</div>
            </div>

            <div class="uri-container">
                <el-input v-model="otpUri" placeholder="OTP URI" class="uri-input">
                    <template slot="prepend">
                        <i class="fas fa-link"></i>
                    </template>
                </el-input>

                <div class="uri-actions">
                    <button class="btn" @click="copyUri">
                        <i class="fas fa-copy"></i> 复制URI
                    </button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>© 2025 NOTP 动态口令生成器 | 安全验证解决方案</p>
    </footer>
</div>

<script>
    // 应用常量
    const CONSTANTS = {
        BASE32_CHARS: "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",
        DEFAULT_SECRET: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',
        DEFAULT_PERIOD: 30,
        DEFAULT_DIGITS: 6,
        DEFAULT_ALGORITHM: 'sha1',
        TOKEN_ANIMATION_DURATION: 500,
        MIN_UPDATE_INTERVAL: 1000
    };

    new Vue({
        el: '#app',
        data() {
            return {
                current: '', // 当前时间显示
                duration: 0, // 倒计时剩余秒数
                token: '------', // 生成的令牌
                tokenUpdated: false, // 令牌更新动画状态
                lastUpdate: 0, // 上次更新时间戳
                qrCodeLoaded: false, // 二维码加载状态
                qrCode: null, // QRCode实例
                loading: false, // 加载状态
                error: '', // 错误信息
                timer: null, // 定时器引用
                visibilityHandler: null, // 页面可见性处理函数

                // 表单数据
                form: {
                    duration: CONSTANTS.DEFAULT_PERIOD,
                    digits: CONSTANTS.DEFAULT_DIGITS,
                    algorithm: CONSTANTS.DEFAULT_ALGORITHM,
                    secret: CONSTANTS.DEFAULT_SECRET,
                    account: 'user@example.com',
                    issuer: 'NOTP Auth'
                }
            }
        },

        computed: {
            // 进度条百分比
            progressPercentage() {
                return (this.duration / this.form.duration) * 100;
            },

            // 进度条颜色
            progressColor() {
                return this.duration < 10 ? 'var(--danger-color)' : 'var(--primary-color)';
            },

            // 生成OTP URI
            otpUri() {
                return `otpauth://totp/${encodeURIComponent(this.form.issuer)}:${encodeURIComponent(this.form.account)}?` +
                    `secret=${this.form.secret}&issuer=${encodeURIComponent(this.form.issuer)}&` +
                    `algorithm=${this.form.algorithm}&digits=${this.form.digits}&period=${this.form.duration}`;
            }
        },

        watch: {
            // 监听表单变化
            form: {
                handler() {
                    this.generateTOTP();
                    this.generateQRCode();
                },
                deep: true,
                immediate: true
            },

            // 监听周期变化
            'form.duration': function () {
                this.resetTimer();
            },

            // 监听URI变化
            'otpUri': function () {
                this.generateQRCode();
            }
        },

        mounted() {
            // 初始化应用
            this.initializeApp();
        },

        beforeDestroy() {
            // 清理资源
            this.cleanupResources();
        },

        methods: {
            /**
             * 初始化应用
             */
            initializeApp() {
                this.startTimer();
                this.generateTOTP();
            },

            /**
             * 清理资源
             */
            cleanupResources() {
                clearInterval(this.timer);
                document.removeEventListener('visibilitychange', this.handleVisibilityChange);
            },

            /**
             * 格式化进度文本
             */
            format() {
                return this.duration;
            },

            /**
             * 生成新密钥
             */
            generateSecret() {
                this.form.secret = notp.Common.generateSecret(32);
            },

            /**
             * 复制密钥
             */
            copySecret() {
                this.copyText(this.form.secret, '密钥');
            },

            /**
             * 生成TOTP令牌
             */
            generateTOTP() {
                try {
                    this.loading = true;
                    this.error = '';

                    this.token = notp.TOTP.generate({
                        secret: this.form.secret,
                        period: this.form.duration,
                        digits: this.form.digits,
                        algorithm: this.form.algorithm
                    });
                    this.tokenUpdated = true;
                    this.lastUpdate = Date.now();

                    // 重置动画状态
                    setTimeout(() => {
                        this.tokenUpdated = false;
                    }, 500);
                } catch (e) {
                    console.error('生成TOTP错误:', e);
                    this.error = '生成令牌失败，请检查密钥格式';
                    this.token = 'ERROR';
                } finally {
                    this.loading = false;
                }
            },
            /**
             * 启动定时器
             */
            startTimer() {
                this.updateDuration();
                if (!this.timer) {
                    this.timer = setInterval(() => {
                        this.updateDuration();
                        this.current = dayjs().format('YYYY-MM-DD HH:mm:ss');
                    }, 1000);
                }
            },

            /**
             * 更新倒计时
             */
            updateDuration() {
                const duration = this.form.duration;
                const now = Math.floor(Date.now() / 1000);
                const elapsed = now % duration;
                this.duration = duration - elapsed;

                // 当倒计时结束时更新令牌
                if (this.duration === duration && Date.now() - this.lastUpdate > 1000) {
                    this.generateTOTP();
                }
            },

            /**
             * 重置定时器
             */
            resetTimer() {
                clearInterval(this.timer);
                this.timer = null;
                this.startTimer();
                this.generateTOTP();
            },

            /**
             * 复制URI
             */
            copyUri() {
                this.copyText(this.otpUri, 'OTP URI');
            },

            /**
             * 复制文本到剪贴板
             */
            copyText(text, type) {
                if (!text) {
                    this.$message.warning('没有内容可复制');
                    return;
                }

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.$message.success(`${type}已复制到剪贴板`);
                    }).catch(err => {
                        console.error('复制失败:', err);
                        this.$message.error('复制失败，请手动复制');
                    });
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        this.$message.success(`${type}已复制到剪贴板`);
                    } catch (err) {
                        console.error('复制失败:', err);
                        this.$message.error('复制失败，请手动复制');
                    }
                    document.body.removeChild(textarea);
                }
            },

            /**
             * 生成二维码
             */
            generateQRCode() {
                if (!this.otpUri) return;

                if (this.qrCode) {
                    this.qrCode.clear();
                    this.qrCode.makeCode(this.otpUri);
                    return;
                }

                this.qrCodeLoaded = false;

                // 使用nextTick确保DOM更新
                this.$nextTick(() => {
                    try {
                        this.qrCode = new QRCode(this.$refs.qrcode, {
                            text: this.otpUri,
                            width: 160,
                            height: 160,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        this.qrCodeLoaded = true;
                    } catch (e) {
                        console.error('生成二维码失败:', e);
                        this.error = '生成二维码失败';
                    }
                });
            }
        }
    })
</script>
</body>
</html>